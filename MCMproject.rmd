---
title: 'Компьютерная работа №2'
author: "Группа 6: Королева Яна, Заруцкий Михаил, Лесных Мария, Ольховский Феликс"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r message = FALSE, warning = FALSE, echo = FALSE}
library(knitr)
library(kableExtra)
library(magrittr)
library(openxlsx)
library(pander)
library(corrplot)
library(caret)
library(FactoMineR)
library(factoextra)
library(devtools)
library(rio)
library(corrplot)
library(psych)
library(ggpubr)
library(REdaS)
```

### Recap

Продолжаем исследовать ценообразование на рынке недвижимости напримере данных штате Айова, США. Итак, в первой части мы предположили, что на цену продажи дома могут влиять следующие факторы: жилая площадь, площадь подвала, гаража, крытого крыльца, год постройки и продажи, а также принадлежность району. Загрузим заново данные и проведем аналогичные предыдущей части проекта разования:
```{r}
housing <- read.csv("housing.csv")
housing <- dplyr::mutate_if(housing, is.character, as.factor)
housing = housing %>% dplyr::select(SalePrice, LotArea, YearBuilt, YrSold, GrLivArea, TotalBsmtSF, GarageArea, EnclosedPorch, Neighborhood)

out_of_1.5IQR <- boxplot.stats(housing$SalePrice)$out
housing <- housing %>% filter(housing$SalePrice < min(out_of_1.5IQR))
```

Повторное описание данных:

```{r}
desc <- read.xlsx('housing_var.xlsx', sheet = 'Description_of_variables')
kbl(desc, caption = "Таблица 2. Описание отобранных переменных", booktabs = T, 
    col.names = c("Переменная", "Описание переменной, англ")) %>% 
  kable_classic_2(html_font = "Cambria", font_size = 10, full_width = F) %>%
  pack_rows("Зависимая переменная", 1, 1) %>%
  pack_rows("Объясняющая переменная", 2, 8) %>%
  pack_rows("Прочее", 9, 9)
```


### Выделение главных компонент


Перед тем как применить МГК, нужно первично проанализировать данные и проверить обоснованность его использования. Удалим целевую и нечисловые переменные из исходного датасета и посмотрим на распределение переменных с помощью ящичковых диаграмм:
```{r}
df1 <- housing[, 2:8]

boxplot(df1, xaxt = "n", cex.lab = 0.7)
text(x =  seq_along(names(df1)), y = par("usr")[3] - 1, srt = 35, adj = 1,
     labels = names(df1), xpd = TRUE, cex = 0.6)
```


График оказался нечитаем из-за неравномерного распределения -- слишком много выбросов у всех переменных. Применим простейшую нормировку данных, это приближает эмпирическое распределение к нормальному, что позволяет использовать тесты для проверки адекватности выборки применению методов компонентного анализа. Посмотрим, что изменится:
```{r}
df1_new <- scale(df1)

boxplot(df1_new, xaxt = "n", cex.lab = 0.7)
text(x =  seq_along(names(df1_new)), y = par("usr")[3] - 1, srt = 35, adj = 1,
     labels = names(df1_new), xpd = TRUE, cex = 0.6)
```

Действительно, благодаря нормированию средние находятся на одном уровне, а интерквартильные размахи примерно равны, поэтому мы можем работать с новым датасетом

\
Теперь построим корреляционную матрицу по отнормированным данным:
```{r}
corrplot(cor(df1_new), type = "full", method = "circle", tl.col = "black", col = COL2('PuOr', 10), tl.srt = 45, tl.cex = 0.5)
```

ВЫВОДЫЫЫЫЫЫЫ

\
Снижение размерности будет достигаться, если признаки, описывающие совокупность, достаточно коррелированы между собой. Применим тест сферичности `Бартлетта`, который используется для оценки эффективности методов снижения размерности. Он проверяет нулевую гипотезу о том, что теоретическая корреляционная матрица многомерного распределения вектора случайных величин является единичной матрицей. Если нулевая гипотеза отвергается, предпосылки применения метода главных компонента будут выполнены.
```{r}
bart_spher(df1_new)
```

Полученное значение `p-value` очень мало и составляет $< 2.22e-16$, что точно меньше уровня значимости в $5\%$, поэтому мы можем отвергнуть нулевую гипотезу, предпосылки применения метода главных компонента будут выполнены.


\
Теперь нужно определить оптимальное количество главных компонент, которые необходимо оставить для дальнейшего анализа. Попробуем это сделать тремя разными способами.

> Метод Кайзера

Этот метод предполагает отбор тех главных компонент, которым соответствует собственное значение $> 1$
```{r message=FALSE, warning=FALSE}
pca <- PCA(df1_new, graph = FALSE)
pander(pca$eig)

plot(eigen(cor(df1_new))$values, bstick = TRUE, type = 'b', main = '', xlab = 'Номер компоненты', 
     ylab = 'Собственное значение')
abline(h = 1, col = 'darkorchid4', lwd = 2)
text(x = 6, y = 1.1, 'eigen value = 1', col = 'darkorchid4')
```

Из таблички видно, что параметр `eigenvalue` превышает единицу только в первых двух компонентах, однако график определяет оптимальным число $3$ (собственное значение очень близко к единице и составляет $0.9962$).

> Критерий каменистой осыпи

На основе анализа "графика каменистой осыпи" мы должны будем выбрать такое число компонент, после которого происходит резкое падение доли сохраненной дисперсии:

```{r}
fviz_eig(pca, addlabels = TRUE, barfill="white", barcolor ="black",
               linecolor ='darkorchid4')
```

Судя по графику, мы должны отобрать $2$ компоненты (резкое падение только от $1$ до $2$).

> Доля суммарной вариации

Теперь воспользуемся другим методом -- определим оптимальное число в соответствии с долей суммарной вариации исходных признаков, которую требуется сохранить.

```{r message=FALSE, warning=FALSE}
princomp <- princomp(df1_new, cor = TRUE) 

cumvarsum <- cumsum(princomp$sdev^2 / sum(princomp$sdev^2))*100
plot(cumvarsum, bstick = TRUE, type = 'b', main = '', xlab = 'Номер компоненты', 
     ylab = 'Кумулятивное значение вариации, %')

abline(h = 70, col = 'darkorchid4', lwd = 2)
abline(h = 80, col = 'darkgoldenrod2', lwd = 2)
text(x = 7, y = 75, '70%', col = 'darkorchid4')
text(x = 7, y = 85, '80%', col = 'darkgoldenrod2')
``` 

В промежуток от $70\%$ до $80\%$ (именно такую долю обычно требуется сохранить) вошло одно значение -- $4$, именно такое число главных компонент будет обеспечивать необходимую долю суммарной вариации.

\
Итак, финально мы решили, что оптимальное число ГК -- $3$, так как $2$ по критерию каменистой осыпи и таблице с собственными значчениями не обеспечут необходимую долю суммарной вариации, а $4$ было бы слишком большим значением при существовании всего $7$ переменных. Суммарный вклад первых главных компонент можно увидеть в столбце `cumulative percentage of variance` в таблице выше: три отобранные ГК объясняют $65.4\%$ вариации. График накопленного вклада главных компонент в суммарную дисперсию исходного признакового пространства можно увидеть чуть выше.


\

Проведём ЛДА:
